<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sun Tracker Remote</title>
    <style>
        :root {
            --primary-color: #ff9800;
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #ffffff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .container {
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        h1 {
            font-weight: 300;
            margin-bottom: 30px;
            opacity: 0.8;
        }

        /* Big Central Button */
        .main-button {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(145deg, #ffa726, #f57c00);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3), 0 6px 6px rgba(0,0,0,0.2);
            color: white;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 auto 40px auto;
            -webkit-tap-highlight-color: transparent;
        }

        .main-button:active {
            transform: scale(0.95);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .main-button span {
            font-size: 14px;
            font-weight: normal;
            margin-top: 5px;
            opacity: 0.9;
        }

        /* Settings / IP Input */
        .settings-panel {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }

        input[type="text"] {
            background-color: #333;
            border: 1px solid #444;
            color: white;
            padding: 12px;
            border-radius: 8px;
            width: 70%;
            font-size: 16px;
            text-align: center;
            margin-bottom: 10px;
        }

        .status-bar {
            margin-top: 15px;
            font-size: 14px;
            color: #888;
            min-height: 20px;
        }

        .status-success { color: #4caf50; }
        .status-error { color: #f44336; }

        /* Secondary Controls (Hidden by default or small) */
        .secondary-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        .btn-small {
            padding: 8px 16px;
            background-color: #333;
            border: none;
            border-radius: 6px;
            color: #aaa;
            font-size: 12px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Sun Tracker</h1>

        <button class="main-button" onclick="sendCommand('move45')">
            45Â° CW
            <span>TAP TO TURN</span>
        </button>

        <div class="settings-panel">
            <div id="status" class="status-bar">Connecting to Cloud...</div>
            
            <div class="secondary-controls">
                <button class="btn-small" onclick="sendCommand('stop')">STOP</button>
                <button class="btn-small" onclick="sendCommand('cw')">Full CW</button>
                <button class="btn-small" onclick="sendCommand('ccw')">Full CCW</button>
            </div>
        </div>
    </div>

    <!-- Include Paho MQTT JS Client -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>

    <script>
        // MQTT Configuration
        const mqtt_broker = "broker.emqx.io";
        const mqtt_port = 8083; // WebSocket port (Secure WSS is 8084, but mixed content might be an issue if not careful. GitHub Pages is HTTPS, so we should use WSS)
        const mqtt_topic_cmd = "suntracker/cmd";
        const mqtt_topic_status = "suntracker/status";
        
        let client;
        let isConnected = false;

        function connectMQTT() {
            const clientId = "WebClient-" + Math.random().toString(16).substr(2, 8);
            // Use WSS (Secure WebSockets) for GitHub Pages compatibility
            client = new Paho.MQTT.Client(mqtt_broker, 8084, "/mqtt", clientId);

            client.onConnectionLost = onConnectionLost;
            client.onMessageArrived = onMessageArrived;

            const options = {
                useSSL: true,
                onSuccess: onConnect,
                onFailure: onFailure,
                keepAliveInterval: 30
            };

            showStatus("Connecting to Cloud...", "");
            client.connect(options);
        }

        function onConnect() {
            console.log("MQTT Connected");
            isConnected = true;
            showStatus("Online & Ready", "success");
            client.subscribe(mqtt_topic_status);
        }

        function onFailure(message) {
            console.log("Connection failed: " + message.errorMessage);
            showStatus("Cloud Connection Failed", "error");
            setTimeout(connectMQTT, 5000); // Retry
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log("onConnectionLost:"+responseObject.errorMessage);
                showStatus("Connection Lost", "error");
                isConnected = false;
                setTimeout(connectMQTT, 5000); // Retry
            }
        }

        function onMessageArrived(message) {
            console.log("Status update: " + message.payloadString);
            // Optional: Update UI based on status
            // showStatus(message.payloadString, "success");
        }

        function sendCommand(action) {
            if (!isConnected) {
                showStatus("Not Connected!", "error");
                return;
            }

            message = new Paho.MQTT.Message(action);
            message.destinationName = mqtt_topic_cmd;
            client.send(message);
            showStatus("Sent: " + action, "");
        }

        function showStatus(msg, type) {
            const el = document.getElementById('status');
            el.textContent = msg;
            el.className = 'status-bar ' + (type === 'success' ? 'status-success' : type === 'error' ? 'status-error' : '');
        }

        // Start connection on load
        window.onload = connectMQTT;
    </script>
</body>
</html>